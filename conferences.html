<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Omicentra | Conferences</title>
  <meta name="description" content="Find where bioinformatics happens next. Track conferences. Never miss a deadline." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <div class="container">
    <header aria-label="Site header">
      <a class="brand" href="/index.html" aria-label="Go to Omicentra homepage">
        <div class="logo" aria-hidden="true">O</div>
        <div class="brand-text">
          <strong>Omicentra</strong>
          <small>Spotlight on bioinformatics</small>
        </div>
      </a>

      <nav class="topnav" aria-label="Primary navigation">
        <a class="navlink" href="/index.html">Home</a>
        <a class="navlink" href="/conferences.html" aria-current="page">Conferences</a>
      </nav>
    </header>

    <main id="main" tabindex="-1">
      <h1>Conferences</h1>
      <p class="lead">Find where bioinformatics happens next. Track conferences. Never miss a deadline.</p>

      <section class="filters" aria-label="Conference filters">
        <div>
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="Search" autocomplete="off" />
        </div>

        <div>
          <label for="region">Region</label>
          <select id="region">
            <option value="all">All</option>
          </select>
        </div>

        <div>
          <label for="topic">Topic</label>
          <select id="topic">
            <option value="all">All</option>
          </select>
        </div>

        <div>
          <label for="format">Format</label>
          <select id="format">
            <option value="all">All</option>
          </select>
        </div>

        <div>
          <label for="deadline">Deadline</label>
          <select id="deadline">
            <option value="all">All</option>
            <option value="only">Only with deadline</option>
          </select>
        </div>

        <div>
          <label class="sr-only" for="reset">Reset filters</label>
          <button id="reset" class="btn" type="button">Reset</button>
        </div>
      </section>

      <div class="viewbar" aria-label="View options">
        <div class="seg" role="group" aria-label="View toggle">
          <button id="viewCards" type="button" aria-pressed="true">Cards</button>
          <button id="viewTable" type="button" aria-pressed="false">Table</button>
        </div>
        <p class="status" id="status" role="status" aria-live="polite"></p>
      </div>

      <section class="grid" id="grid" aria-label="Conference cards"></section>

      <section class="tablewrap" id="tablewrap" aria-label="Conference table" hidden>
        <table>
          <thead>
            <tr>
              <th scope="col" id="th-name" aria-sort="none">
                <button class="thbtn" type="button" data-sort="name" aria-label="Sort by conference name">Conference</button>
              </th>

              <th scope="col" id="th-dates" aria-sort="none">
                <button class="thbtn" type="button" data-sort="dates" aria-label="Sort by dates">Dates</button>
              </th>

              <th scope="col">Location</th>
              <th scope="col">Region</th>
              <th scope="col">Format</th>
              <th scope="col">Topics</th>

              <th scope="col" id="th-deadline" aria-sort="ascending">
                <button class="thbtn" type="button" data-sort="deadline" aria-label="Sort by deadline">Deadline</button>
              </th>

              <th scope="col">Website</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </section>
    </main>

    <footer aria-label="Footer">
      <div>© <span id="year" aria-label="Current year"></span> Omicentra</div>
      <div><a href="/index.html">Home</a></div>
    </footer>
  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const DATA_URL = "/data/conferences.json";
    const URGENT_DAYS = 30;

    const q = document.getElementById("q");
    const regionSel = document.getElementById("region");
    const topicSel = document.getElementById("topic");
    const formatSel = document.getElementById("format");
    const deadlineSel = document.getElementById("deadline");
    const resetBtn = document.getElementById("reset");

    const viewCardsBtn = document.getElementById("viewCards");
    const viewTableBtn = document.getElementById("viewTable");

    const grid = document.getElementById("grid");
    const tableWrap = document.getElementById("tablewrap");
    const tbody = document.getElementById("tbody");
    const statusEl = document.getElementById("status");

    const thName = document.getElementById("th-name");
    const thDates = document.getElementById("th-dates");
    const thDeadline = document.getElementById("th-deadline");

    let conferences = [];
    let currentView = "cards";

    // Default sort: soonest deadline first (by remaining days)
    let sortKey = "deadline";
    let sortDir = "asc";

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function midnightTs(){
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    }

    function parseIsoMidnight(iso){
      if (!iso) return null;
      const t = Date.parse(iso + "T00:00:00");
      return Number.isNaN(t) ? null : t;
    }

    function isConferencePastOrOngoing(c){
      const today = midnightTs();

      const start = parseIsoMidnight(c.start_date);
      const end = parseIsoMidnight(c.end_date);

      // If both missing -> keep (unknown)
      if (start === null && end === null) return false;

      // If only start: if start <= today => ongoing/past
      if (start !== null && end === null) return start <= today;

      // If only end: if end < today => past, else keep
      if (start === null && end !== null) return end < today;

      // Both present:
      if (end < today) return true; // past
      if (start <= today && end >= today) return true; // ongoing
      return false; // upcoming
    }

    function formatDate(iso){
      if (!iso) return "TBA";
      const d = new Date(iso + "T00:00:00");
      if (Number.isNaN(d.getTime())) return "TBA";
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
    }

    function formatDateRange(startIso, endIso){
      if (!startIso && !endIso) return "TBA";
      if (startIso && !endIso) return formatDate(startIso);
      if (!startIso && endIso) return formatDate(endIso);

      const start = new Date(startIso + "T00:00:00");
      const end = new Date(endIso + "T00:00:00");
      if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return "TBA";

      const sameYear = start.getFullYear() === end.getFullYear();
      const sameMonth = sameYear && start.getMonth() === end.getMonth();

      const sDay = start.toLocaleDateString(undefined, { day:"2-digit" });
      const sMon = start.toLocaleDateString(undefined, { month:"short" });
      const eDay = end.toLocaleDateString(undefined, { day:"2-digit" });
      const eMon = end.toLocaleDateString(undefined, { month:"short" });

      if (sameMonth){
        const year = start.getFullYear();
        return `${sDay} – ${eDay} ${eMon} ${year}`;
      }

      if (sameYear){
        const year = start.getFullYear();
        return `${sDay} ${sMon} – ${eDay} ${eMon} ${year}`;
      }

      return `${formatDate(startIso)} – ${formatDate(endIso)}`;
    }

    function toKey(s){
      return String(s || "").trim().toLowerCase().replace(/\s+/g, "-");
    }

    function uniqSorted(arr){
      return Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b));
    }

    function normalizeRegion(v){
      const x = String(v || "").trim();
      if (!x) return "Unknown";
      if (x.toLowerCase() === "usa") return "USA";
      return x;
    }

    function normalizeFormat(v){
      const x = String(v || "").trim().toLowerCase();
      if (!x) return "unknown";
      return x;
    }

    function topicList(c){
      const t = Array.isArray(c.topic) ? c.topic : (c.topic ? [c.topic] : []);
      return t.map(x => String(x)).filter(Boolean);
    }

    function buildSelect(selectEl, values){
      const current = selectEl.value || "all";
      selectEl.innerHTML = '<option value="all">All</option>';
      for (const v of values){
        const opt = document.createElement("option");
        opt.value = toKey(v);
        opt.textContent = v;
        selectEl.appendChild(opt);
      }
      if ([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
    }

    function shortLocation(c){
      const country = String(c.location_country || "").trim();
      let city = String(c.location_city || "").trim();

      if (!city && country) return country;
      if (!country && city) return city;
      if (!city && !country) return "TBA";

      // If city contains multiple comma-separated parts (>=3), drop the first part (usually too detailed)
      const parts = city.split(",").map(s => s.trim()).filter(Boolean);
      if (parts.length >= 3){
        city = parts.slice(1).join(", ");
      }

      // Avoid duplicating country if city already ends with it
      const cityEndsWithCountry = country && city.toLowerCase().endsWith(country.toLowerCase());
      let loc = cityEndsWithCountry ? city : `${city}, ${country}`;

      // If still too long, keep start + country
      if (loc.length > 34){
        const keepCountry = country ? `, ${country}` : "";
        const base = cityEndsWithCountry ? city : city;
        const shortBase = base.slice(0, 22).trimEnd();
        loc = `${shortBase}…${keepCountry}`;
      }

      return loc;
    }

    function conferenceDateRange(c){
      return formatDateRange(c.start_date, c.end_date);
    }

    function conferenceDeadline(c){
      return c.submission_deadline ? formatDate(c.submission_deadline) : "—";
    }

    function deadlineDaysLeft(iso){
      if (!iso) return Infinity;
      const d = parseIsoMidnight(iso);
      if (d === null) return Infinity;
      const diffDays = Math.floor((d - midnightTs()) / (24*60*60*1000));
      // Past deadlines go last
      if (diffDays < 0) return Infinity;
      return diffDays;
    }

    function deadlineUrgency(iso){
      const days = deadlineDaysLeft(iso);
      const isUrgent = Number.isFinite(days) && days <= URGENT_DAYS;
      return { isUrgent, days: Number.isFinite(days) ? days : null };
    }

    function renderCard(c){
  const name = c.name || "Untitled";
  const website = c.website || "#";
  const format = normalizeFormat(c.format);

  const { isUrgent } = deadlineUrgency(c.submission_deadline);

  const chips = [];
  chips.push({ text: shortLocation(c), cls: "chip" });
  chips.push({ text: conferenceDateRange(c), cls: "chip" });

  if (c.submission_deadline){
    chips.push({
      text: `Deadline: ${formatDate(c.submission_deadline)}`,
      cls: `chip chip--deadline${isUrgent ? " chip--urgent" : ""}`
    });
  }

  const chipHtml = chips
    .filter(x => x.text && x.text !== "TBA")
    .map(x => `<span class="${x.cls}">${escapeHtml(x.text)}</span>`)
    .join("");

  const article = document.createElement("article");
  article.className = "card";

  // format color
  const isOnsite = (format === "onsite");
  article.classList.add(isOnsite ? "card--onsite" : "card--remote");

  // urgent styling
  if (isUrgent) article.classList.add("card--urgent");

  article.dataset.title = String(name).toLowerCase();
  article.dataset.region = toKey(normalizeRegion(c.region));
  article.dataset.format = toKey(format);
  article.dataset.topic = topicList(c).map(t => toKey(t)).join("|");
  article.dataset.deadline = c.submission_deadline ? String(c.submission_deadline) : "";

  article.innerHTML = `
    <h2>${escapeHtml(name)}</h2>
    <div class="meta">${chipHtml}</div>
    <div class="card-actions">
      <a class="cta cta--tiny" href="${escapeHtml(website)}" target="_blank" rel="noopener noreferrer"
         aria-label="Open conference website: ${escapeHtml(name)}">
        Website
      </a>
    </div>
  `;

  return article;
}


    function renderRow(c){
      const name = c.name || "Untitled";
      const website = c.website || "#";
      const region = normalizeRegion(c.region);
      const format = normalizeFormat(c.format);
      const topics = topicList(c);

      const tr = document.createElement("tr");
      tr.dataset.title = String(name).toLowerCase();
      tr.dataset.region = toKey(region);
      tr.dataset.format = toKey(format);
      tr.dataset.topic = topics.map(t => toKey(t)).join("|");
      tr.dataset.deadline = c.submission_deadline ? String(c.submission_deadline) : "";

      tr.innerHTML = `
        <td class="tname">${escapeHtml(name)}</td>
        <td>${escapeHtml(conferenceDateRange(c))}</td>
        <td>${escapeHtml(shortLocation(c))}</td>
        <td>${escapeHtml(region)}</td>
        <td>${escapeHtml(format)}</td>
        <td>${escapeHtml(topics.join(", ") || "—")}</td>
        <td>${escapeHtml(conferenceDeadline(c))}</td>
        <td class="tlink">
          <a href="${escapeHtml(website)}" target="_blank" rel="noopener noreferrer"
             aria-label="Open conference website: ${escapeHtml(name)}">
            Website
          </a>
        </td>
      `;
      return tr;
    }

    function nodesForFiltering(){
      return currentView === "cards"
        ? Array.from(grid.children)
        : Array.from(tbody.children);
    }

    function applyFilters(){
      const qv = q.value.trim().toLowerCase();
      const rv = regionSel.value;
      const tv = topicSel.value;
      const fv = formatSel.value;
      const dv = deadlineSel.value;

      let count = 0;

      for (const node of nodesForFiltering()){
        const title = node.dataset.title || "";
        const r = node.dataset.region || "all";
        const f = node.dataset.format || "all";
        const topics = (node.dataset.topic || "").split("|").filter(Boolean);
        const hasDeadline = (node.dataset.deadline || "") !== "";

        const matchQ = qv === "" || title.includes(qv);
        const matchR = rv === "all" || r === rv;
        const matchF = fv === "all" || f === fv;
        const matchT = tv === "all" || topics.includes(tv);
        const matchD = dv === "all" || (dv === "only" && hasDeadline);

        const ok = matchQ && matchR && matchT && matchF && matchD;

        node.style.display = ok ? "" : "none";
        if (ok) count++;
      }

      statusEl.textContent = `${count} conference${count === 1 ? "" : "s"}`;
    }

    function setView(view){
      currentView = view;
      const isCards = view === "cards";

      viewCardsBtn.setAttribute("aria-pressed", String(isCards));
      viewTableBtn.setAttribute("aria-pressed", String(!isCards));

      grid.hidden = !isCards;
      tableWrap.hidden = isCards;

      applyFilters();

      try { localStorage.setItem("omicentra_view", view); } catch {}
    }

    function sortConferences(){
      const dir = sortDir === "asc" ? 1 : -1;

      conferences.sort((a, b) => {
        if (sortKey === "name"){
          const an = String(a.name || "").toLowerCase();
          const bn = String(b.name || "").toLowerCase();
          return an.localeCompare(bn) * dir;
        }

        if (sortKey === "dates"){
          const as = parseIsoMidnight(a.start_date) ?? Infinity;
          const bs = parseIsoMidnight(b.start_date) ?? Infinity;
          if (as !== bs) return (as - bs) * dir;

          const ae = parseIsoMidnight(a.end_date) ?? Infinity;
          const be = parseIsoMidnight(b.end_date) ?? Infinity;
          return (ae - be) * dir;
        }

        // deadline: sort by remaining days
        const ad = deadlineDaysLeft(a.submission_deadline);
        const bd = deadlineDaysLeft(b.submission_deadline);
        if (ad !== bd) return (ad - bd) * dir;

        // tie-breaker: upcoming start date
        const as = parseIsoMidnight(a.start_date) ?? Infinity;
        const bs = parseIsoMidnight(b.start_date) ?? Infinity;
        return (as - bs) * dir;
      });
    }

    function updateAriaSort(){
      const none = "none";
      const asc = "ascending";
      const desc = "descending";

      thName.setAttribute("aria-sort", sortKey === "name" ? (sortDir === "asc" ? asc : desc) : none);
      thDates.setAttribute("aria-sort", sortKey === "dates" ? (sortDir === "asc" ? asc : desc) : none);
      thDeadline.setAttribute("aria-sort", sortKey === "deadline" ? (sortDir === "asc" ? asc : desc) : none);
    }

    function rerender(){
      grid.innerHTML = "";
      tbody.innerHTML = "";
      for (const c of conferences){
        grid.appendChild(renderCard(c));
        tbody.appendChild(renderRow(c));
      }
      updateAriaSort();
      applyFilters();
    }

    function setSort(key){
      if (sortKey === key){
        sortDir = (sortDir === "asc") ? "desc" : "asc";
      } else {
        sortKey = key;
        sortDir = "asc";
      }
      sortConferences();
      rerender();
    }

    function attachSortHandlers(){
      const buttons = Array.from(document.querySelectorAll(".thbtn[data-sort]"));
      for (const b of buttons){
        b.addEventListener("click", () => {
          const key = b.getAttribute("data-sort");
          if (key === "name" || key === "dates" || key === "deadline") setSort(key);
        });
      }
    }

    async function loadData(){
      statusEl.textContent = "Loading…";

      const res = await fetch(DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to load ${DATA_URL} (${res.status})`);

      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Invalid JSON: expected an array");

      // Filter out past and ongoing conferences before anything else
      const upcoming = data.filter(c => !isConferencePastOrOngoing(c));
      conferences = upcoming.slice();

      // Build filters from upcoming only
      const regions = uniqSorted(conferences.map(c => normalizeRegion(c.region)).filter(Boolean));
      const formats = uniqSorted(conferences.map(c => normalizeFormat(c.format)).filter(Boolean).map(f => f));
      const topics = uniqSorted(conferences.flatMap(c => topicList(c)).filter(Boolean));

      buildSelect(regionSel, regions);
      buildSelect(topicSel, topics);

      formatSel.innerHTML = '<option value="all">All</option>';
      for (const f of formats){
        const opt = document.createElement("option");
        opt.value = toKey(f);
        opt.textContent = f; // keep lowercase e.g. onsite
        formatSel.appendChild(opt);
      }

      // Default sort: shortest time to deadline (past deadlines go last)
      sortKey = "deadline";
      sortDir = "asc";
      sortConferences();
      rerender();

      // Restore view preference
      let saved = "cards";
      try { saved = localStorage.getItem("omicentra_view") || "cards"; } catch {}
      setView(saved === "table" ? "table" : "cards");

      attachSortHandlers();
    }

    q.addEventListener("input", applyFilters);
    regionSel.addEventListener("change", applyFilters);
    topicSel.addEventListener("change", applyFilters);
    formatSel.addEventListener("change", applyFilters);
    deadlineSel.addEventListener("change", applyFilters);

    resetBtn.addEventListener("click", () => {
      q.value = "";
      regionSel.value = "all";
      topicSel.value = "all";
      formatSel.value = "all";
      deadlineSel.value = "all";
      applyFilters();
      q.focus();
    });

    viewCardsBtn.addEventListener("click", () => setView("cards"));
    viewTableBtn.addEventListener("click", () => setView("table"));

    loadData().catch(err => {
      console.error(err);
      statusEl.textContent = "Failed to load conferences.";
      grid.innerHTML = "";
      tbody.innerHTML = "";
    });
  </script>
</body>
</html>
